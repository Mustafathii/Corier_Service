<?php

namespace App\Imports;

use App\Models\Shipment;
use App\Models\User;
use App\Models\Governorate;
use App\Models\City;
use App\Models\Zone;
use Maatwebsite\Excel\Concerns\ToModel;
use Maatwebsite\Excel\Concerns\WithHeadingRow;
use Maatwebsite\Excel\Concerns\WithValidation;
use Maatwebsite\Excel\Concerns\WithChunkReading;
use PhpOffice\PhpSpreadsheet\Shared\StringHelper;
use Carbon\Carbon;
use Illuminate\Support\Facades\Log;

class ShipmentsImport implements ToModel, WithHeadingRow, WithValidation, WithChunkReading
{
    public function __construct()
    {
        // ÿ™ÿπŸäŸäŸÜ encoding ŸÑŸÑŸÖŸÉÿ™ÿ®ÿ©
        StringHelper::setDecimalSeparator('.');
        StringHelper::setThousandsSeparator(',');
    }

    public function model(array $row)
    {
        // ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
        Log::info('Raw row data:', $row);

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿÆÿßÿµÿ© ŸÑŸÑŸÜÿµŸàÿµ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
        foreach ($row as $key => $value) {
            if (is_string($value)) {
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©
                Log::info("Original value for {$key}: " . bin2hex($value));

                // ÿ™ŸÜÿ∏ŸäŸÅ Ÿàÿ™ÿ≠ŸàŸäŸÑ encoding
                $row[$key] = $this->fixArabicEncoding($value);

                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÇŸäŸÖÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ
                Log::info("Fixed value for {$key}: " . $row[$key]);
            }
        }

        // üéØ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÄ Seller
        $sellerId = null;
        if (isset($row['seller_company']) && !empty($row['seller_company'])) {
            $seller = User::where('company_name', $row['seller_company'])
                        ->whereHas('roles', function ($q) {
                            $q->where('name', 'Seller');
                        })
                        ->first();
            if ($seller) {
                $sellerId = $seller->id;
            }
        }

        // üéØ ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÄ Driver
        $driverId = null;
        if (isset($row['driver']) && !empty($row['driver'])) {
            $driver = User::where('name', $row['driver'])
                        ->whereHas('roles', function ($q) {
                            $q->where('name', 'Driver');
                        })
                        ->first();
            if ($driver) {
                $driverId = $driver->id;
            }
        }

        // üó∫Ô∏è ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑŸÖÿ≠ÿ≥ŸÜ - ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ© ŸàÿßŸÑŸÖÿØŸäŸÜÿ© ŸàÿßŸÑŸÖŸÜÿ∑ŸÇÿ©
        $governorateId = null;
        $cityId = null;
        $zoneId = null;
        $calculatedShippingCost = null;

        // ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ÿπŸÜ ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ©
        if (isset($row['governorate']) && !empty($row['governorate'])) {
            $governorateInput = trim($row['governorate']);
            $normalizedGovInput = $this->normalizeArabicText($governorateInput);

            $governorate = Governorate::where('is_active', true)
                ->where(function($q) use ($governorateInput, $normalizedGovInput) {
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±
                    $q->where('governorate_name_ar', 'LIKE', '%' . $governorateInput . '%')
                      ->orWhere('governorate_name_en', 'LIKE', '%' . $governorateInput . '%')
                      // ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ∑ÿ®ÿπ (normalized)
                      ->orWhereRaw('REPLACE(REPLACE(REPLACE(governorate_name_ar, "ÿ£", "ÿß"), "ÿ•", "ÿß"), "ÿ¢", "ÿß") LIKE ?', ['%' . $normalizedGovInput . '%'])
                      // ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿπŸÉÿ≥Ÿä
                      ->orWhere('governorate_name_ar', 'LIKE', '%ÿßÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©%')
                        ->when(stripos($governorateInput, 'ÿßÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©') !== false, function($query) {
                            return $query->orWhere('governorate_name_ar', 'LIKE', '%ÿßŸÑÿ£ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©%');
                        })
                      // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
                      ->orWhere('governorate_name_en', 'LIKE', '%' . strtolower($governorateInput) . '%');
                })
                ->first();

            if ($governorate) {
                $governorateId = $governorate->id;
                Log::info("‚úÖ Smart match found governorate: {$governorate->governorate_name_ar} for input: {$governorateInput}");
            } else {
                Log::warning("‚ùå Could not find governorate for: {$governorateInput}");
            }
        }

        // ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ÿπŸÜ ÿßŸÑŸÖÿØŸäŸÜÿ©
        if (isset($row['city']) && !empty($row['city'])) {
            $cityInput = trim($row['city']);
            $normalizedCityInput = $this->normalizeArabicText($cityInput);

            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸÜÿ¨ÿØ ŸÖÿ≠ÿßŸÅÿ∏ÿ©ÿå ÿ≠ÿßŸàŸÑ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨Ÿáÿß ŸÖŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿØŸäŸÜÿ©
            if (!$governorateId) {
                $extractedGov = $this->extractGovernorateFromCombined($cityInput);
                if ($extractedGov) {
                    $governorate = Governorate::where('is_active', true)
                        ->where(function($q) use ($extractedGov) {
                            $normalizedExtracted = $this->normalizeArabicText($extractedGov);
                            $q->where('governorate_name_ar', 'LIKE', '%' . $extractedGov . '%')
                              ->orWhere('governorate_name_en', 'LIKE', '%' . $extractedGov . '%')
                              ->orWhereRaw('REPLACE(REPLACE(REPLACE(governorate_name_ar, "ÿ£", "ÿß"), "ÿ•", "ÿß"), "ÿ¢", "ÿß") LIKE ?', ['%' . $normalizedExtracted . '%']);
                        })
                        ->first();

                    if ($governorate) {
                        $governorateId = $governorate->id;
                        $cityInput = $this->extractCityFromCombined($cityInput);
                        $normalizedCityInput = $this->normalizeArabicText($cityInput);
                        Log::info("üîÑ Auto-extracted governorate: {$governorate->governorate_name_ar} from city input: {$row['city']}");
                    }
                }
            }

            if ($governorateId) {
                $city = City::where('governorate_id', $governorateId)
                    ->where('is_active', true)
                    ->where(function($q) use ($cityInput, $normalizedCityInput) {
                        // ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±
                        $q->where('city_name_ar', 'LIKE', '%' . $cityInput . '%')
                          ->orWhere('city_name_en', 'LIKE', '%' . $cityInput . '%')
                          // ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ∑ÿ®ÿπ
                          ->orWhereRaw('REPLACE(REPLACE(REPLACE(city_name_ar, "Ÿâ", "Ÿä"), "ÿ©", "Ÿá"), "ÿ™", "Ÿá") LIKE ?', ['%' . $normalizedCityInput . '%'])
                          // ÿ≠ÿßŸÑÿßÿ™ ÿÆÿßÿµÿ©
                          ->orWhere('city_name_ar', 'LIKE', '%ÿßŸÑÿØŸÇŸâ%')
                            ->when(stripos($cityInput, 'ÿØŸÇŸä') !== false, function($query) {
                                return $query->orWhere('city_name_ar', 'LIKE', '%ÿßŸÑÿØŸÇŸâ%');
                            })
                          // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
                          ->orWhere('city_name_en', 'LIKE', '%' . strtolower($cityInput) . '%');
                    })
                    ->first();

                if ($city) {
                    $cityId = $city->id;
                    Log::info("‚úÖ Smart match found city: {$city->city_name_ar} (ID: {$city->id}) for input: {$cityInput}");

                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÜÿ¥ÿ∑ÿ© ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÖÿØŸäŸÜÿ©
                    $zone = Zone::where('city_id', $cityId)
                        ->where('is_active', true)
                        ->first();

                    if ($zone) {
                        $zoneId = $zone->id;
                        Log::info("‚úÖ Found active zone: {$zone->zone_name} for city ID: {$cityId}");

                        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÜŸàÿπ ÿßŸÑÿ¥ÿ≠ŸÜÿ©
                        $shipmentType = isset($row['shipment_type']) && !empty($row['shipment_type'])
                            ? strtolower(trim($row['shipment_type']))
                            : 'standard';

                        // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ŸÜŸàÿπ ÿßŸÑÿ¥ÿ≠ŸÜÿ© ÿµÿ≠Ÿäÿ≠
                        if (!in_array($shipmentType, ['standard', 'express', 'same_day'])) {
                            $shipmentType = 'standard';
                        }

                        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ŸÖŸÜ ÿßŸÑŸÄ zone
                        if (method_exists($zone, 'getCostByType')) {
                            $calculatedShippingCost = $zone->getCostByType($shipmentType);
                        } else {
                            // Fallback manual calculation
                            switch ($shipmentType) {
                                case 'express':
                                    $calculatedShippingCost = $zone->express_cost ?? ($zone->shipping_cost * 1.5);
                                    break;
                                case 'same_day':
                                    $calculatedShippingCost = $zone->same_day_cost ?? ($zone->shipping_cost * 2);
                                    break;
                                default:
                                    $calculatedShippingCost = $zone->shipping_cost;
                            }
                        }

                        Log::info("üí∞ Calculated shipping cost: {$calculatedShippingCost} EGP for type: {$shipmentType}");
                    } else {
                        Log::warning("‚ùå No active zone found for city ID: {$cityId} ({$city->city_name_ar})");
                    }
                } else {
                    Log::warning("‚ùå Could not find city: {$cityInput} in governorate ID: {$governorateId}");
                }
            } else {
                Log::warning("‚ùå No governorate found, cannot search for city: {$cityInput}");
            }
        }

        // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©
        $finalShippingCost = $calculatedShippingCost ?? ($row['shipping_cost'] ?? 15.00);

        // ÿ™ÿ≠ÿØŸäÿØ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ ÿßŸÑŸÖÿ™ŸàŸÇÿπ
        $expectedDeliveryDate = Carbon::now()->addDay(); // ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
        if ($zoneId) {
            $zone = Zone::find($zoneId);
            if ($zone && $zone->estimated_delivery_days) {
                $expectedDeliveryDate = Carbon::now()->addDays($zone->estimated_delivery_days);
            }
        } elseif (isset($row['expected_delivery_date']) && !empty($row['expected_delivery_date'])) {
            $expectedDeliveryDate = Carbon::parse($row['expected_delivery_date']);
        }

        // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿ¥ÿ≠ŸÜÿ© ŸÖÿπ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
        $shipmentType = 'standard';
        if (isset($row['shipment_type']) && !empty($row['shipment_type'])) {
            $type = strtolower(trim($row['shipment_type']));

            // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ©
            if (in_array($type, ['standard', 'express', 'same_day'])) {
                $shipmentType = $type;
            } else {
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÇŸäŸÖÿ© ŸÖÿ¥ ŸÖŸÜ ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©ÿå ÿÆŸÑŸäŸáÿß standard
                $shipmentType = 'standard';
                Log::info("Invalid shipment_type '{$row['shipment_type']}' converted to 'standard'");
            }
        }

        // ÿ™ÿ≠ÿØŸäÿØ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ ŸÖÿπ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÇŸäŸÖ ÿ®ÿ≠ÿßŸÑÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ©
        $paymentMethod = 'cod';
        if (isset($row['payment_method']) && !empty($row['payment_method'])) {
            $method = strtolower(trim($row['payment_method']));

            // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ©
            if ($method === 'cod' || $method === 'cash on delivery') {
                $paymentMethod = 'cod';
            } elseif ($method === 'prepaid' || $method === 'paid') {
                $paymentMethod = 'prepaid';
            } elseif ($method === 'electronic_wallet' || $method === 'wallet' || $method === 'e-wallet') {
                $paymentMethod = 'electronic_wallet';
            } else {
                // ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                $paymentMethod = 'cod';
                Log::info("Invalid payment_method '{$row['payment_method']}' converted to 'cod'");
            }
        }

        // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ≠ÿßŸÑÿ©
        $status = 'in_transit';
        if (isset($row['status']) && !empty($row['status'])) {
            $statusValue = strtolower(str_replace(' ', '_', trim($row['status'])));
            $validStatuses = ['pending', 'picked_up', 'in_transit', 'out_for_delivery', 'delivered', 'failed_delivery', 'returned', 'canceled'];
            if (in_array($statusValue, $validStatuses)) {
                $status = $statusValue;
            }
        }

        $shipment = new Shipment([
            // ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
            'tracking_number' => $row['tracking_number'] ?? $this->generateTrackingNumber(),
            'status' => $status,

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ≥ŸÑ
            'sender_name' => !empty($row['sender_name']) ? $row['sender_name'] : null,
            'sender_phone' => !empty($row['sender_phone']) ? $row['sender_phone'] : null, // ÿπÿßÿØŸä ÿ®ÿØŸàŸÜ cast
            'sender_address' => !empty($row['sender_address']) ? $row['sender_address'] : null,
            'sender_city' => !empty($row['sender_city']) ? $row['sender_city'] : null,
            'seller_id' => $sellerId,

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ ŸÖÿπ ŸÖÿπÿßŸÑÿ¨ÿ© receiver_city ÿßŸÑŸÅÿßÿ∂Ÿä
            'receiver_name' => $row['receiver_name'],
            'receiver_phone' => $row['receiver_phone'] ?? '', // ÿπÿßÿØŸä ÿ®ÿØŸàŸÜ cast
            'receiver_address' => $row['receiver_address'],
            'receiver_city' => !empty($row['receiver_city'])
                ? $row['receiver_city']
                : (!empty($row['city']) ? $row['city'] : 'Unknown'), // ÿßÿ≥ÿ™ÿÆÿØŸÖ city ŸÑŸà receiver_city ŸÅÿßÿ∂Ÿä

            // üó∫Ô∏è ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ - ÿßŸÑŸÖŸàÿßŸÇÿπ
            'governorate_id' => $governorateId,
            'city_id' => $cityId,
            'zone_id' => $zoneId,

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿ≠ŸÜ ŸàÿßŸÑÿ™ÿ≥ÿπŸäÿ±
            'shipment_type' => $shipmentType,
            'weight' => $row['weight'] ?? 1,
            'shipping_cost' => $finalShippingCost,
            'payment_method' => $paymentMethod,
            'cod_amount' => ($paymentMethod === 'cod') ? ($row['cod_amount'] ?? 0) : 0,

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸàŸÇŸäÿ™
            'pickup_date' => isset($row['pickup_date']) && !empty($row['pickup_date'])
                ? Carbon::parse($row['pickup_date']) : null,
            'expected_delivery_date' => $expectedDeliveryDate,
            'actual_delivery_date' => isset($row['actual_delivery_date']) && !empty($row['actual_delivery_date'])
                ? Carbon::parse($row['actual_delivery_date']) : null,

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ±ÿØ
            'package_type' => $row['package_type'] ?? 'Standard',
            'quantity' => $row['quantity'] ?? 1,
            'declared_value' => $row['declared_value'] ?? 0,
            'description' => $row['description'] ?? null,

            // ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
            'notes' => $row['notes'] ?? null,
            'internal_notes' => $row['internal_notes'] ?? null,

            // ÿßŸÑÿ≥ÿßÿ¶ŸÇ
            'driver_id' => $driverId,
        ]);

        Log::info('Final shipment data to be saved:', [
            'tracking_number' => $shipment->tracking_number,
            'governorate_id' => $shipment->governorate_id,
            'city_id' => $shipment->city_id,
            'zone_id' => $shipment->zone_id,
            'shipment_type' => $shipment->shipment_type,
            'shipping_cost' => $shipment->shipping_cost,
            'calculated_cost' => $calculatedShippingCost,
            'original_cost' => $row['shipping_cost'] ?? 'N/A'
        ]);

        return $shipment;
    }

    /**
     * ÿ™ÿ∑ÿ®Ÿäÿπ ÿßŸÑŸÜÿµŸàÿµ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÑŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä
     */
    private function normalizeArabicText($text)
    {
        if (empty($text)) {
            return $text;
        }

        // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸáŸÖÿ≤ÿßÿ™ ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ© ŸÑÿ£ŸÑŸÅ ÿπÿßÿØŸäÿ©
        $text = str_replace(['ÿ£', 'ÿ•', 'ÿ¢'], 'ÿß', $text);

        // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸäÿßÿ° ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ©
        $text = str_replace(['Ÿâ', 'Ÿä'], 'Ÿä', $text);

        // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ™ÿßÿ° ÿßŸÑŸÖÿ±ÿ®Ÿàÿ∑ÿ© ŸàÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©
        $text = str_replace(['ÿ©', 'ÿ™'], 'Ÿá', $text);

        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ÿßŸÑÿ≤ÿßÿ¶ÿØÿ©
        $text = trim($text);

        return $text;
    }

    /**
     * ÿ™ÿ∑ÿ®Ÿäÿπ ÿßŸÑŸÜÿµŸàÿµ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ŸÑŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä
     */
    private function normalizeEnglishText($text)
    {
        if (empty($text)) {
            return $text;
        }

        // ÿ™ÿ≠ŸàŸäŸÑ ŸÑÿ£ÿ≠ÿ±ŸÅ ÿµÿ∫Ÿäÿ±ÿ©
        $text = strtolower($text);

        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ÿßŸÑÿ≤ÿßÿ¶ÿØÿ©
        $text = trim($text);

        return $text;
    }

    /**
     * ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ© ŸÖŸÜ ŸÜÿµ ŸÖÿØŸÖÿ¨ ŸÖÿ´ŸÑ "ÿßÿ≥ŸÉŸÜÿØÿ±Ÿäÿ© ÿßŸÑÿπÿµÿßŸÅÿ±ÿ©"
     */
    private function extractGovernorateFromCombined($input)
    {
        $input = trim($input);

        // ŸÇÿßÿ¶ŸÖÿ© ÿ®ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿßÿ™ ÿßŸÑŸÖÿ¥ŸáŸàÿ±ÿ©
        $governorateVariations = [
            'ÿßŸÑŸÇÿßŸáÿ±ÿ©' => ['ŸÇÿßŸáÿ±ÿ©', 'cairo'],
            'ÿßŸÑÿ¨Ÿäÿ≤ÿ©' => ['ÿ¨Ÿäÿ≤ÿ©', 'giza'],
            'ÿßŸÑÿ£ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©' => ['ÿßÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©', 'ÿ•ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©', 'ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©', 'alexandria', 'alex'],
            'ÿßŸÑÿØŸÇŸáŸÑŸäÿ©' => ['ÿØŸÇŸáŸÑŸäÿ©', 'dakahlia'],
            'ÿßŸÑÿ∫ÿ±ÿ®Ÿäÿ©' => ['ÿ∫ÿ±ÿ®Ÿäÿ©', 'gharbiya'],
            'ÿßŸÑÿ¥ÿ±ŸÇŸäÿ©' => ['ÿ¥ÿ±ŸÇŸäÿ©', 'sharkia'],
            'ÿßŸÑŸÖŸÜŸàŸÅŸäÿ©' => ['ŸÖŸÜŸàŸÅŸäÿ©', 'menofia'],
            'ÿßŸÑÿ®ÿ≠Ÿäÿ±ÿ©' => ['ÿ®ÿ≠Ÿäÿ±ÿ©', 'beheira'],
            'ŸÉŸÅÿ± ÿßŸÑÿ¥ŸäÿÆ' => ['ŸÉŸÅÿ± ÿßŸÑÿ¥ŸäÿÆ', 'kafr el sheikh'],
            'ÿØŸÖŸäÿßÿ∑' => ['ÿØŸÖŸäÿßÿ∑', 'damietta'],
            'ÿ®Ÿàÿ±ÿ≥ÿπŸäÿØ' => ['ÿ®Ÿàÿ±ÿ≥ÿπŸäÿØ', 'port said'],
            'ÿßŸÑÿ•ÿ≥ŸÖÿßÿπŸÑŸäÿ©' => ['ÿßÿ≥ŸÖÿßÿπŸäŸÑŸäÿ©', 'ÿ•ÿ≥ŸÖÿßÿπŸäŸÑŸäÿ©', 'ismailia'],
            'ÿßŸÑÿ≥ŸàŸäÿ≥' => ['ÿ≥ŸàŸäÿ≥', 'suez'],
            'ÿ¨ŸÜŸàÿ® ÿ≥ŸäŸÜÿßÿ°' => ['ÿ¨ŸÜŸàÿ® ÿ≥ŸäŸÜÿßÿ°', 'south sinai'],
            'ÿ¥ŸÖÿßŸÑ ÿ≥ŸäŸÜÿßÿ°' => ['ÿ¥ŸÖÿßŸÑ ÿ≥ŸäŸÜÿßÿ°', 'north sinai'],
            'ÿßŸÑÿ®ÿ≠ÿ± ÿßŸÑÿ£ÿ≠ŸÖÿ±' => ['ÿ®ÿ≠ÿ± ÿßÿ≠ŸÖÿ±', 'red sea'],
            'ÿßŸÑÿ£ŸÇÿµÿ±' => ['ÿßŸÇÿµÿ±', 'luxor'],
            'ÿßÿ≥ŸàÿßŸÜ' => ['ÿ£ÿ≥ŸàÿßŸÜ', 'aswan'],
            'ŸÇŸÜÿß' => ['ŸÇŸÜÿß', 'qena'],
            'ÿ≥ŸàŸáÿßÿ¨' => ['ÿ≥ŸàŸáÿßÿ¨', 'sohag'],
            'ÿßÿ≥ŸäŸàÿ∑' => ['ÿ£ÿ≥ŸäŸàÿ∑', 'assiut'],
            'ÿßŸÑŸÖŸÜŸäÿß' => ['ŸÖŸÜŸäÿß', 'minya'],
            'ÿ®ŸÜŸä ÿ≥ŸàŸäŸÅ' => ['ÿ®ŸÜŸä ÿ≥ŸàŸäŸÅ', 'beni suef'],
            'ÿßŸÑŸÅŸäŸàŸÖ' => ['ŸÅŸäŸàŸÖ', 'fayoum'],
            'ŸÖÿ∑ÿ±Ÿàÿ≠' => ['ŸÖÿ∑ÿ±Ÿàÿ≠', 'matrouh'],
            'ÿßŸÑŸàÿßÿØŸä ÿßŸÑÿ¨ÿØŸäÿØ' => ['ŸàÿßÿØŸä ÿ¨ÿØŸäÿØ', 'new valley'],
            'ÿßŸÑŸÇŸÑŸäŸàÿ®Ÿäÿ©' => ['ŸÇŸÑŸäŸàÿ®Ÿäÿ©', 'qaliubiya'],
            'ÿ¨ŸÜŸàÿ® ÿ≥ŸäŸÜÿßÿ°' => ['ÿ¨ŸÜŸàÿ® ÿ≥ŸäŸÜÿßÿ°', 'south sinai', 'ÿ¨ŸÜŸàÿ®ÿ≥ŸäŸÜÿßÿ°'],
            'ÿ¥ŸÖÿßŸÑ ÿ≥ŸäŸÜÿßÿ°' => ['ÿ¥ŸÖÿßŸÑ ÿ≥ŸäŸÜÿßÿ°', 'north sinai', 'ÿ¥ŸÖÿßŸÑÿ≥ŸäŸÜÿßÿ°'],
            'ÿßŸÑÿ®ÿ≠ÿ± ÿßŸÑÿ£ÿ≠ŸÖÿ±' => ['ÿ®ÿ≠ÿ± ÿßÿ≠ŸÖÿ±', 'ÿßŸÑÿ®ÿ≠ÿ±ÿßŸÑÿßÿ≠ŸÖÿ±', 'red sea'],
            'ÿßŸÑÿ£ŸÇÿµÿ±' => ['ÿßŸÇÿµÿ±', 'ÿßŸÑÿßŸÇÿµÿ±', 'luxor'],
            'ÿßÿ≥ŸàÿßŸÜ' => ['ÿ£ÿ≥ŸàÿßŸÜ', 'ÿßÿ≥ŸàÿßŸÜ', 'aswan'],
            'ŸÇŸÜÿß' => ['ŸÇŸÜÿß', 'qena'],
            'ÿ≥ŸàŸáÿßÿ¨' => ['ÿ≥ŸàŸáÿßÿ¨', 'sohag'],
            'ÿßÿ≥ŸäŸàÿ∑' => ['ÿ£ÿ≥ŸäŸàÿ∑', 'ÿßÿ≥ŸäŸàÿ∑', 'assiut'],
            'ÿßŸÑŸÖŸÜŸäÿß' => ['ŸÖŸÜŸäÿß', 'ÿßŸÑŸÖŸÜŸäÿß', 'minya'],
            'ÿ®ŸÜŸä ÿ≥ŸàŸäŸÅ' => ['ÿ®ŸÜŸä ÿ≥ŸàŸäŸÅ', 'ÿ®ŸÜŸäÿ≥ŸàŸäŸÅ', 'beni suef'],
            'ÿßŸÑŸÅŸäŸàŸÖ' => ['ŸÅŸäŸàŸÖ', 'ÿßŸÑŸÅŸäŸàŸÖ', 'fayoum'],
            'ŸÖÿ∑ÿ±Ÿàÿ≠' => ['ŸÖÿ∑ÿ±Ÿàÿ≠', 'matrouh'],
            'ÿßŸÑŸàÿßÿØŸä ÿßŸÑÿ¨ÿØŸäÿØ' => ['ŸàÿßÿØŸä ÿ¨ÿØŸäÿØ', 'ÿßŸÑŸàÿßÿØŸäÿßŸÑÿ¨ÿØŸäÿØ', 'new valley'],
            'ÿßŸÑŸÇŸÑŸäŸàÿ®Ÿäÿ©' => ['ŸÇŸÑŸäŸàÿ®Ÿäÿ©', 'ÿßŸÑŸÇŸÑŸäŸàÿ®ŸäŸá', 'qaliubiya']
        ];

        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ™ÿ∑ÿßÿ®ŸÇ
        foreach ($governorateVariations as $official => $variations) {
            foreach ($variations as $variation) {
                if (stripos($input, $variation) !== false) {
                    Log::info("üéØ Matched governorate '{$official}' from input '{$input}' using variation '{$variation}'");
                    return $official;
                }
            }
        }

        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ£ÿÆŸäÿ±ÿ© - ÿ£ŸàŸÑ ŸÉŸÑŸÖÿ©
        $words = explode(' ', $input);
        if (count($words) > 1) {
            $firstWord = $words[0];
            // ÿ¨ÿ±ÿ® ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿ£ŸàŸÑ ŸÉŸÑŸÖÿ©
            foreach ($governorateVariations as $official => $variations) {
                foreach ($variations as $variation) {
                    if (stripos($firstWord, $variation) !== false || stripos($variation, $firstWord) !== false) {
                        Log::info("üéØ Matched governorate '{$official}' from first word '{$firstWord}'");
                        return $official;
                    }
                }
            }
        }

        Log::warning("‚ùì Could not extract governorate from: {$input}");
        return null;
    }

    /**
     * ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿØŸäŸÜÿ© ŸÖŸÜ ŸÜÿµ ŸÖÿØŸÖÿ¨
     */
    private function extractCityFromCombined($input)
    {
        $input = trim($input);

        // ŸÇÿßÿ¶ŸÖÿ© ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿßÿ™ ŸÑŸÑÿ•ÿ≤ÿßŸÑÿ©
        $governorateNames = [
            'ÿßŸÑŸÇÿßŸáÿ±ÿ©', 'ÿßŸÑÿ¨Ÿäÿ≤ÿ©', 'ÿßŸÑÿ£ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©', 'ÿßÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©', 'ÿ•ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ©',
            'ÿßŸÑÿØŸÇŸáŸÑŸäÿ©', 'ÿßŸÑÿ∫ÿ±ÿ®Ÿäÿ©', 'ÿßŸÑÿ¥ÿ±ŸÇŸäÿ©', 'ÿßŸÑŸÖŸÜŸàŸÅŸäÿ©', 'ÿßŸÑÿ®ÿ≠Ÿäÿ±ÿ©',
            'ŸÉŸÅÿ± ÿßŸÑÿ¥ŸäÿÆ', 'ÿØŸÖŸäÿßÿ∑', 'ÿ®Ÿàÿ±ÿ≥ÿπŸäÿØ', 'ÿßŸÑÿ•ÿ≥ŸÖÿßÿπŸÑŸäÿ©', 'ÿßŸÑÿ≥ŸàŸäÿ≥',
            'ÿ¨ŸÜŸàÿ® ÿ≥ŸäŸÜÿßÿ°', 'ÿ¥ŸÖÿßŸÑ ÿ≥ŸäŸÜÿßÿ°', 'ÿßŸÑÿ®ÿ≠ÿ± ÿßŸÑÿ£ÿ≠ŸÖÿ±', 'ÿßŸÑÿ£ŸÇÿµÿ±',
            'ÿßÿ≥ŸàÿßŸÜ', 'ŸÇŸÜÿß', 'ÿ≥ŸàŸáÿßÿ¨', 'ÿßÿ≥ŸäŸàÿ∑', 'ÿßŸÑŸÖŸÜŸäÿß', 'ÿ®ŸÜŸä ÿ≥ŸàŸäŸÅ',
            'ÿßŸÑŸÅŸäŸàŸÖ', 'ŸÖÿ∑ÿ±Ÿàÿ≠', 'ÿßŸÑŸàÿßÿØŸä ÿßŸÑÿ¨ÿØŸäÿØ', 'ÿßŸÑŸÇŸÑŸäŸàÿ®Ÿäÿ©'
        ];

        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿ≤ÿßŸÑÿ© ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ© ŸÖŸÜ ÿ®ÿØÿßŸäÿ© ÿßŸÑŸÜÿµ
        foreach ($governorateNames as $govName) {
            if (stripos($input, $govName) === 0) {
                $cityPart = trim(str_ireplace($govName, '', $input));
                if (!empty($cityPart)) {
                    Log::info("üèôÔ∏è Extracted city '{$cityPart}' after removing governorate '{$govName}' from '{$input}'");
                    return $cityPart;
                }
            }
        }

        // ÿ•ÿ∞ÿß ŸÑŸÖ ŸÜÿ¨ÿØ ŸÖÿ≠ÿßŸÅÿ∏ÿ© ŸÅŸä ÿßŸÑÿ®ÿØÿßŸäÿ©ÿå ÿÆÿ∞ ÿ¢ÿÆÿ± ŸÉŸÑŸÖÿ©
        $words = explode(' ', $input);
        if (count($words) > 1) {
            $lastWord = end($words);
            Log::info("üèôÔ∏è Using last word '{$lastWord}' as city from input '{$input}'");
            return $lastWord;
        }

        Log::info("üèôÔ∏è Using full input '{$input}' as city");
        return $input;
    }
    private function fixArabicEncoding($text)
    {
        if (empty($text)) {
            return $text;
        }

        // ÿ•ÿ≤ÿßŸÑÿ© BOM
        $text = str_replace(["\xEF\xBB\xBF", "\xFF\xFE", "\xFE\xFF"], '', $text);

        // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™
        $text = trim($text);

        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÜÿµ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ£ÿ≠ÿ±ŸÅ ÿ∫ÿ±Ÿäÿ®ÿ©ÿå ÿ¨ÿ±ÿ® ÿ™ÿ≠ŸàŸäŸÑÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ©
        if (preg_match('/[\x80-\xFF]/', $text) && !preg_match('/[\x{0600}-\x{06FF}]/u', $text)) {
            // ÿ¨ÿ±ÿ® ÿ™ÿ≠ŸàŸäŸÑÿßÿ™ encoding ŸÖÿÆÿ™ŸÑŸÅÿ©
            $encodings = [
                'Windows-1256',
                'ISO-8859-6',
                'UTF-8',
                'CP1256',
                'ISO-8859-1'
            ];

            foreach ($encodings as $encoding) {
                try {
                    $converted = mb_convert_encoding($text, 'UTF-8', $encoding);
                    // ÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ŸäŸÜÿ™ÿ¨ ŸÜÿµ ÿπÿ±ÿ®Ÿä ÿµÿ≠Ÿäÿ≠
                    if (preg_match('/[\x{0600}-\x{06FF}]/u', $converted)) {
                        return $converted;
                    }
                } catch (\Exception $e) {
                    continue;
                }
            }
        }

        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÜÿµ Ÿäÿ®ÿØŸà ÿ£ŸÜŸá UTF-8 ŸÖŸèÿπÿ∑ŸÑÿå ÿ¨ÿ±ÿ® ÿ•ÿµŸÑÿßÿ≠Ÿá
        if (!mb_check_encoding($text, 'UTF-8')) {
            $text = mb_convert_encoding($text, 'UTF-8', 'UTF-8');
        }

        return $text;
    }

    private function generateTrackingNumber()
    {
        do {
            $trackingNumber = 'DP-' . date('Y') . str_pad(mt_rand(1, 99999999), 7, '0', STR_PAD_LEFT);
        } while (Shipment::where('tracking_number', $trackingNumber)->exists());

        return $trackingNumber;
    }

    public function rules(): array
    {
        return [
            // ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
            'tracking_number' => ['nullable', 'string', 'max:255', 'unique:shipments,tracking_number'],
            'status' => ['nullable', 'string'],

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ≥ŸÑ
            'sender_name' => ['nullable', 'string', 'max:255'],
            'sender_phone' => ['nullable', 'string', 'max:20'],
            'sender_address' => ['nullable', 'string'],
            'sender_city' => ['nullable', 'string', 'max:255'],
            'seller_company' => ['nullable', 'string'],

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ - ÿ™ÿπÿØŸäŸÑ receiver_phone ŸÑŸäŸÉŸàŸÜ numeric
            'receiver_name' => ['required', 'string', 'max:255'],
            'receiver_phone' => ['required', 'numeric'], // ÿπÿØŸÑŸÜÿßŸáÿß ŸÑŸÄ numeric
            'receiver_address' => ['required', 'string'],
            'receiver_city' => ['nullable', 'string', 'max:255'], // ŸÖÿ¥ required ÿπÿ¥ÿßŸÜ ŸÜŸÇÿØÿ± ŸÜÿπÿßŸÑÿ¨Ÿá

            // üó∫Ô∏è ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ - ÿßŸÑŸÖŸàÿßŸÇÿπ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ© ŸÑÿ£ŸÜŸáÿß Ÿáÿ™ÿ™ÿ≠ÿØÿØ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã)
            'governorate' => ['nullable', 'string', 'max:255'],
            'city' => ['nullable', 'string', 'max:255'],
            'zone' => ['nullable', 'string', 'max:255'],

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ¥ÿ≠ŸÜ ŸàÿßŸÑÿ™ÿ≥ÿπŸäÿ± - ÿ™ÿÆŸÅŸäŸÅ ÿßŸÑŸÇŸäŸàÿØ
            'shipment_type' => ['nullable', 'string'], // ÿ•ÿ≤ÿßŸÑÿ© in validation
            'weight' => ['nullable', 'numeric', 'min:0.01'],
            'shipping_cost' => ['nullable', 'numeric', 'min:0'],
            'payment_method' => ['nullable', 'string'], // ÿ•ÿ≤ÿßŸÑÿ© in validation
            'cod_amount' => ['nullable', 'numeric', 'min:0'],

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ŸàŸÇŸäÿ™
            'pickup_date' => ['nullable', 'date'],
            'expected_delivery_date' => ['nullable', 'date'],
            'actual_delivery_date' => ['nullable', 'date'],

            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ÿ±ÿØ
            'package_type' => ['nullable', 'string', 'max:255'],
            'quantity' => ['nullable', 'integer', 'min:1'],
            'declared_value' => ['nullable', 'string'], // string ÿπÿ¥ÿßŸÜ ŸäŸÇÿ®ŸÑ ŸÅÿßÿ∂Ÿä
            'description' => ['nullable', 'string'],

            // ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
            'notes' => ['nullable', 'string'],
            'internal_notes' => ['nullable', 'string'],

            // ÿßŸÑÿ≥ÿßÿ¶ŸÇ
            'driver' => ['nullable', 'string'],
        ];
    }

    public function chunkSize(): int
    {
        return 500; // ŸÇŸÑŸÑÿ™ ÿßŸÑÿ±ŸÇŸÖ ÿ¥ŸàŸäÿ© ÿπÿ¥ÿßŸÜ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
    }
}
